
#{extends 'main_tekstvisning.html' /}
#{ header /}


<script>

  $(document).ready(function() {
  
      var readerNum = 0;
      var columnWidth = 471; // how wide new columns should be, in pixels
      rootFile = "${asset.fileNameWithoutXml}";
      numOfPictures = ${asset.numberOfPictures};

        $("#ny_kolonne_bar").click(function() {
            readerNum += 1;
            addNewReader(readerNum);
            number_of_present_tabreaders = $(".tabReader").length;

            // make room for more columns
            // increase width of .container and #høyre
            if(number_of_present_tabreaders > 1){ // only do this if there are 1 or more tabReaders opened
                $(".container").width($(".container").width() + columnWidth);
            }

            $("#høyre").width($("#høyre").width() + columnWidth);

            resize_window();

            // give new column same font size as existing
            $( ".text-resizeable" ).css('font-size', $('#hovedtekst .text-resizeable').css('font-size'));

            // scroll to rightmost side of page
            $(window).scrollTo('100%', 0 , {duration:700});


        });

        $(".lukk_kolonne_knapp").live('click', function() {        
            
            number_of_present_tabreaders = $(".tabReader").length;
            
            $(this).parent().parent().parent().parent().remove(); // hide entire tabreader
            $("#høyre").width($("#høyre").width() - columnWidth);

            if(number_of_present_tabreaders > 1){ // only do this if there are 1 or more tabReaders opened

                // decrease width of .container and #høyre
                $(".container").width($(".container").width() - columnWidth);
                
            }
            resize_window();
            return false; // hindrer at vi bytter side
        });

   var addNewReader = function(num) {
    
    var newReader = '<span class="tabReader"><div id="tab' + num + '"> <ul> <li class="selected"><a href="#innledning' + num + '"><span>Innledning</span></a></li> <li><a class="variant_tab" href="#variant' + num + '"><span>Varianter</span></a></li> <li><a href="#faksimile' + num + '"><span>Faksimile</span></a></li> <li><a class="kommentar_tab" href="#kommentar' + num + '"><span>Kommentarer</span></a></li> <li id="lukk_kolonne_knapp_li"><a title="Skjul kolonne" href="#skjul" class="lukk_kolonne_knapp"></a></li> </ul> <div id="innledning' + num + '"> <div class="innledningContent text-resizeable"><p><img src="public/images/wait.gif"></p></div></div> <div id="variant' + num + '"><div class="variant_select">Vis variant: #{variantsAsDropDown variants:variants /} <a id="variant_vejledning" href="../vejledning/varapp_vej" target="_blank">Vejledning</a></div><div class="variantContent text-resizeable">Variant content</div>  </div> <div id="faksimile' + num + '" class="faksimile_frame" ><div class="faksimile_select"><a class="forrige_side" href="#">Forrige side</a> | <a class="neste_side" href="#">Neste side</a></div> <div class="faksimileContent"></div></div> <div class="kommentar text-resizeable" id="kommentar' + num + '"> Her skal kommentarene ligge...  </div> </div></span>';
    // vis variant-select box over hovedtekst også
      
      var hovedtekstSelect = 'Vis variant: #{variantsAsDropDown variants:variants /}';
      $("#hovedtekst_select").html(hovedtekstSelect);
      //alert(newReader);
         //alert($("#høyre_toppmeny_nytt_navn").html());
      $("#høyre_toppmeny_nytt_navn").html($("#høyre_toppmeny_nytt_navn").html() + newReader);
      //alert($("#høyre_toppmeny_nytt_navn").html());
       
     var i_tab=0;
     for (i_tab = 0; i_tab <= num; i_tab++) {
          $("#tab" + i_tab).tabs();
     }
 
      // dropdown - varianter
      $("#tab" + num +' .variantsAsDropDown').change(function() {
         var theUrl = "ajax/getVariantByName/" + $(this).val();
         $.ajax({
             url: theUrl,
             success: function(data) {
                 var variantContent = $("#tab" + num + " .variantContent");
                 variantContent.html(data);
             }
         })
      });



         // add comments
         var kommentarUrl = "ajax/getComment/" + ${asset.id};
         $.ajax({
             url: kommentarUrl,
             success: function(data) {
                 var introContent = $("#kommentar" + num);
                 introContent.html(data);
                 addTooltip($('.persName'));
                 addTooltip($('.placeName'));
                 addTooltip($('.myth'));
             }
         });

         // add intro
         var introUrl = "ajax/getIntro/" + ${asset.id};
         $.ajax({
             url: introUrl,
             success: function(data) {
                 var introContent = $("#innledning" + num);
                 introContent.find(".innledningContent").html(data);
                 $("a.toc").each(function(index) {
                    var a = $(this);
                    var jump = a.attr("href");
                    a.removeClass("toc");
                    a.click(function() {
                       var id = $(".teidiv1").attr("id");
                       // $(".innledningContent").parent().scrollTo($("#index.xml-body.1_div.1_div.11"));
                    });
                    a.removeAttr("href");
                 });
                 addTooltip($('.persName'));
                 addTooltip($('.placeName'));
                 addTooltip($('.myth'));

             }
         });






      // dropdown - hovedtekst
      $("#hovedtekst .variantsAsDropDown").change(function() {
         var theUrl = "ajax/getVariantByName/" + $(this).val();
         $.ajax({
             url: theUrl,
             success: function(data) {
                 var variantContent = $("#hovedtekst #tekst_innhold");
                 variantContent.html(data);
             }
         })
      });


      // autolast den første varianten & manuset
      $("#tab" + num +' .variantsAsDropDown').trigger('change');
      $("#tab" + num +' .manusAsDropDown').trigger('change');

      // vis hovedtekst select når variant-fanen åpnes
      $('.variant_tab').click(function() {
         $("#hovedtekst_select").show('medium');
         // resize hovedfeltet
         resize_window();
         //$("#tekst_innhold").height($(".variant_content").height() - 0);
      });

      // resize layout når kolonner endres
      resize_window();


      // vis faksimile (https://github.com/can3p/iviewer)
      var iviewer = {};
      var iviewer_src = "public/images/" + rootFile;
      var iviewer_num = 1;
                  $("#faksimile" + num + " .faksimileContent").iviewer(
                  {
                      src: iviewer_src + "_" + iviewer_num + ".jpg",
                      zoom: 'fit',
                      zoom_min: 25,
                      
                      initCallback: function()
                      {
                        iviewer = this;
                      }
                  });

                  $(".neste_side").click(function()
                  {
                    if (iviewer_num + 1 > numOfPictures) return false;
                    iviewer_num += 1;
                    iviewer.loadImage(iviewer_src + "_" + iviewer_num + ".jpg");
                    return false;
                  });

                  $(".forrige_side").click(function()
                  {
                    if (iviewer_num == 1) return false;
                    iviewer_num -= 1;
                    iviewer.loadImage(iviewer_src + "_" + iviewer_num + ".jpg");
                    return false;
                  });


  } // end new reader

    addNewReader(0);

    // tooltip

    var addTooltip = function (tags) {
        tags.cluetip({cluetipClass: 'jtip', closeText : 'Lukk', mouseOutClose: true, width: 375, dropShadow: false, sticky: true, ajaxCache: false, arrows: false});
    }

    var removeTooltip = function(tags) {
        tags.cluetip('destroy');
    }


    // add popup references
    /*

    $('.seg').each(function(index) {
        var elem = $(this);
        var url = "/ajax/getReference/" + rootFile + "/" + elem.attr("id");
        var new_tag = $("<a></a>");
        new_tag.attr("href", url);
        new_tag.attr("rel", url);
        new_tag.attr("class", "reference");
        new_tag.html(elem.html());
        elem.replaceWith(new_tag);

    });

    $('.reference').cluetip({cluetipClass: 'jtip', closeText : 'Lukk', mouseOutClose: true, width: 375, dropShadow: false, sticky: true, ajaxCache: false, arrows: false});

*/

    // add scroll to comment

    $('.seg').each(function(index) {
        var elem = $(this);
        elem.click(function() {
           var target = $("#scrollTarget_" + elem.attr("id"));
           // alert("Looking for id: " + "#scrollTarget_" + elem.attr("id"));
           // switch to "Kommentar" tab

           // if there are no visible tabReaders, we must first add one to show the comments
           if($('.tabReader').length == 0){addNewReader(0);}

           // switch to right tab
           $(".kommentar_tab:first").trigger('click');

           // scroll to target comment
           $(".kommentar").scrollTo(target);
           $(".kommentar").scrollTo("-=30px", 700);
           target.effect("highlight", {}, 5000);
        });

    });

    // resize layout når siden laster
    resize_window();

    // Font-size selector


        /* COOKIE plugin reference
        // Get the value of a cookie:
        $.cookie('sampleCookie');

        // Create (or update) the value of a cookie:
        $.cookie('sampleCookie', 'cookieValue');

        //Create (or update) the value of a cookie to expire in 2 days:
        $.cookie('sampleCookie', 'cookieValue', { expires: 2 });

        // Delete a cookie:
        $.cookie('sampleCookie', null);
        */

        //$.cookie('text_font', 'Klassisk');

        $( "#slider" ).slider({
                value:160,
                min: 110,
                max: 220,
                step: 1,
                animate: true,
                range: 'min',
                slide: function( event, ui ) {
                       // alert("sliding");
                        $.cookie('text_size', ui.value); 	// lagre størrelse satt i slider i cookien
                        $( "#amount" ).text( (ui.value/10) + "px" ); 	// oppdater status div
                        $( ".text-resizeable" ).css('font-size', (ui.value/10) + "px"); 	// resize tekst
                }
        });

        $( "#amount" ).text( ($( "#slider" ).slider( "value" )/10) + "px" ); // oppdater status div


        $("#settings").hover(function()

                          {
                                $("#settings_dropdown").show();
                                // move dropdown to be just below #settings
                                var offset = $(this).offset();
                                $(this).css("background-color", "#fff");
                                $("#settings_dropdown").css("left", offset.left - $(window).scrollLeft() - 33) ;


                          }, function()
                          {     $(this).css("background-color", "transparent");
                                $("#settings_dropdown").hide();
                          }
                  );

                  $("#settings_dropdown").hover(function()

                          {
                                $("#settings_dropdown").show();
                                $("#settings").css("background-color", "#fff");

                          }, function()
                          {
                                $("#settings_dropdown").hide();
                                $("#settings").css("background-color", "transparent");
                          }
                  );


                // sjekk om cookie er satt og gi hovedteksten riktig font

                if($.cookie('text_font') == 'Moderne' ) {
                        // set proper font
                        $( ".text-resizeable" ).css('font-family', 'Myriad Pro, Verdana, sans-serif');
                        // select proper radio button
                        $('#font_georgia').attr('checked', false);
                        $('#font_verdana').attr('checked', true);
                }

                if($.cookie('text_font') == 'Klassisk' ) {
                        // set proper font
                        $( ".text-resizeable" ).css('font-family', 'Georgia, Garamond, serif');
                        // select proper radio button
                        $('#font_georgia').attr('checked', true);
                        $('#font_verdana').attr('checked', false);
                }

                // hva skjer når brukeren velger en annen font?

                $("#font_georgia").click(function()  {	$( ".text-resizeable" ).css('font-family', 'Georgia, Garamond, serif');        $.cookie('text_font', 'Klassisk');  });
                $("#font_verdana").click(function()  {	$( ".text-resizeable" ).css('font-family', 'Myriad Pro, Verdana, sans-serif'); $.cookie('text_font', 'Moderne');   });

                // sett riktig tekst-størrelse

                if($.cookie('text_size') > 0) { // hvis brukeren har brukt slideren tidligere

                      //  alert($.cookie('text_size') );
                        $( ".text-resizeable" ).css('font-size', ($.cookie('text_size')/10) + 'px');  // sett tekst-størrelse
                       
                       $( "#slider" ).slider( "value", $.cookie('text_size') );   			// flytt slider knapp
                }



                




  });





</script>
<div id="main">

	<div class="container">

		<div id="submenu">
		<div id="breadcrumbs"><a href="#">Forside</a> &raquo; <a href="#">Værker</a> &raquo; ${asset.name}</div>
		<!-- <div id="select_view">
			<form action="">
				<input type="radio" name="visning" id="lesevisning" value="1" disabled/><label for="lesevisning">Lesevisning</label>
				<input type="radio" name="visning" id="filologisk_visning" value="2" checked /><label for="filologisk_visning">Filologisk visning</label>
			</form>
		</div>!-->
               
                
               
                <a id="settings" href="">Tekststørrelse & Font</a>

                    <div id="settings_dropdown">

                    <a id="settings_inner" href="">Tekststørrelse & Font</a>
                    <br/><br/>
                    <h4>Størrelse</h4>
                    <span id="small_A">A</span>
                            <div id="slider"></div>
                    <span id="big_A">A</span>

                    <span id="amount" ></span>
                    <br/><br/>

                    <h4>Font</h4>
                    <input type="radio" id="font_georgia" name="group1" value="Klassisk" checked><label id="font_georgia_label" for="font_georgia">Klassisk</label><br>

                    <br><input type="radio" id="font_verdana" name="group1" value="Moderne"> <label id="font_verdana_label" for="font_verdana">Moderne</label><br>

                    </div>

                <span id="hjelp_link"><a id="" href="../vejledning/om_udgaven_vej" target="_blank">Vejledning</a> | </span>
                
		</div>


			<div id="hovedtekst">
				<div id="toppmeny" class="nav_meny">
                                        %{ prevChapter = [0, chapter.num - 1].max(); }%
					<a href="tekstvisning/${asset.id}/${prevChapter}" class="previous" title="Forrige kapittel"></a>
					<span class="chapter">
						<select class="chapterSelector">
                                                    #{list chapters, as:'c'}
                                                        <option value="${c.num}" selected>${c.name}</option>
                                                    #{/list}
						</select>
						</span>
					
                                        %{ nextChapter = [chapter.num + 1, chapters.size - 1].min(); }%
					<a href="tekstvisning/${asset.id}/${nextChapter}" class="next" title="Neste kapittel"></a>
				</div>
				
                                <div id="hovedtekst_select">select box her</div>

				<div id="hovedtekst_toppfade"></div>
				<div id="hovedtekst_bunnfade"></div>


				<div id="tekst_innhold" class="text-resizeable">
                                    ${chapter.html.raw()}
				</div>

				<div id="bunnmeny" class="nav_meny">
					<a href="tekstvisning/${asset.id}/${prevChapter}" class="previous" title="Forrige kapittel"></a>
					<span class="chapter">
						<select class="chapterSelector">
                                                    #{list chapters, as:'c'}
                                                        <option value="${c.num}" selected>${c.name}</option>
                                                    #{/list}
						</select>
						</span>
					<a href="tekstvisning/${asset.id}/${nextChapter}" class="next" title="Neste kapittel"></a>
				</div>

			</div>

		<div id="høyre">
                    <div id="høyre_toppmeny_nytt_navn">
                        
                    </div>
		
		<div id="høyre_toppfade"></div>
		<div id="høyre_bunnfade"></div>
		
		</div>
		
		<div id="ny_kolonne_bar"><span alt="Åpne ny kolonne" id="ny_kolonne_knapp"></span></div>
	</div>
</div>
